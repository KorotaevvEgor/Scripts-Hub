# Система управления доступом к скриптам в Django админке

## Обзор

Реализована система управления доступом пользователей к скриптам в Django админке. Теперь администраторы могут легко контролировать, какие пользователи имеют доступ к тем или иным скриптам.

## Что было добавлено

### 1. Новое поле в модели Script

```python
allowed_users = models.ManyToManyField(
    User,
    blank=True,
    verbose_name='Пользователи с доступом',
    help_text='Пользователи, которые имеют доступ к этому скрипту',
    related_name='accessible_scripts'
)
```

### 2. Методы для управления доступом

- `has_access(user)` - проверяет доступ пользователя к скрипту
- `get_allowed_users_count()` - возвращает количество пользователей с доступом
- `get_allowed_users_names()` - возвращает имена пользователей с доступом

### 3. Обновленная админка

- Добавлен удобный интерфейс `filter_horizontal` для управления пользователями
- Новая колонка "Пользователи с доступом" в списке скриптов
- Оптимизированные запросы к БД через `prefetch_related`

## Логика работы системы доступа

1. **Создатель скрипта** - всегда имеет доступ к своим скриптам
2. **Суперпользователи** - имеют доступ ко всем скриптам в системе
3. **Обычные пользователи** - имеют доступ только к скриптам, к которым им явно предоставлен доступ

## Инструкция по использованию в админке

### Шаг 1: Войдите в админку
Перейдите по адресу `/admin/` и войдите под учетной записью администратора.

### Шаг 2: Откройте раздел скриптов
Найдите и откройте раздел **"Скрипты"** в главном меню админки.

### Шаг 3: Создайте или отредактируйте скрипт
При создании нового скрипта или редактировании существующего, вы увидите секцию **"Управление доступом"**.

### Шаг 4: Настройте доступ пользователей
В поле **"Пользователи с доступом"** вы увидите двойной список:
- **Левая сторона**: Доступные пользователи
- **Правая сторона**: Пользователи с доступом к скрипту

Используйте стрелки между списками для добавления/удаления пользователей.

## Примеры использования в коде

### Проверка доступа пользователя к скрипту

```python
from scripts.models import Script
from django.contrib.auth.models import User

# Получаем скрипт и пользователя
script = Script.objects.get(id=1)
user = User.objects.get(username='developer')

# Проверяем доступ
if script.has_access(user):
    print("У пользователя есть доступ к скрипту")
else:
    print("У пользователя нет доступа к скрипту")
```

### Получение всех скриптов, доступных пользователю

```python
# Через related_name
user_scripts = user.accessible_scripts.all()

# Или фильтрация всех скриптов
accessible_scripts = [
    script for script in Script.objects.all() 
    if script.has_access(user)
]
```

### Получение информации о доступе

```python
script = Script.objects.get(id=1)

# Количество пользователей с доступом
count = script.get_allowed_users_count()

# Имена пользователей (первые 5)
names = script.get_allowed_users_names()

print(f"Доступ имеют {count} пользователей: {names}")
```

## Применение миграций

Система была развернута с помощью миграции:
```bash
python manage.py makemigrations scripts
python manage.py migrate
```

## Тестирование

Для проверки работы системы создан тестовый скрипт `test_access_control.py`, который:
1. Создает тестовых пользователей
2. Создает скрипты с различными настройками доступа
3. Тестирует логику контроля доступа
4. Показывает подробную информацию об использовании

Запуск теста:
```bash
python test_access_control.py
```

## Безопасность

- Все проверки доступа происходят на уровне модели Django
- Создатели скриптов не могут потерять доступ к своим скриптам
- Суперпользователи всегда имеют полный доступ
- Неаутентифицированные пользователи не имеют доступа ни к каким скриптам

## Производительность

- Используется `prefetch_related` для оптимизации запросов
- Методы кэшируют результаты для повторных вызовов
- Эффективная работа с большим количеством пользователей и скриптов

---

*Система управления доступом готова к использованию! Теперь вы можете гибко управлять доступом пользователей к скриптам через Django админку.*
